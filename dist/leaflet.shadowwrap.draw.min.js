L.ShadowWrap.EventsToShadow.push("move"),L.ShadowWrap.EventsToShadow.push("edit"),L.ShadowWrap.EventsToShadow.push("resize"),L.ShadowWrap.EventsToShadow.push("editstart"),L.ShadowWrap.Draw={shadowTypes:["normalizeLL","normLatMirrorLng","mirrorLatNormLng","mirrorLL"],shadowHooks:function(a,e,r){if(e.editing&&e.shadowOptions){if(e.shadowOptions.isShadow)return L.ShadowWrap.Draw.shadowUpdate(a,e,e.shadowOptions.mainShape),void L.ShadowWrap.Draw.shadowHooks(a,e.shadowOptions.mainShape,e.shadowOptions.shadowType);for(var o in e.shadowOptions.shadowShapes)if(e.shadowOptions.shadowShapes.hasOwnProperty(o)){if(r==o)continue;L.ShadowWrap.Draw.shadowUpdate(a,e,e.shadowOptions.shadowShapes[o])}}},initializeShadowHooks:function(){if(!this.options.noShadow&&!this.shadowOptions.isShadow){var a=this,e=function(e){if(a.shadowOptions&&!a.options.noShadow){if(a instanceof L.Polyline||"move"!=e.type||a.unblockShadowChanges(),"edit"==e.type&&(a.unblockShadowChanges(),a instanceof L.CircleMarker)){var r=a.editing._resizeMarkers[0]._latlng;a.setLatLng(a._latlng),a.editing._resizeMarkers[0]._latlng=r,a.editing._resizeMarkers[0].update()}if(!a.shadowOptions.blockChanges){var o=a;e._shadowDispatched&&(o=e._shadowDispatchShape),L.ShadowWrap.Draw.shadowHooks(e.type,o)}a._focusNextUpdate&&(a instanceof L.Marker||"edit"==e.type)&&(L.ShadowWrap.Draw.focusUpdate(a),L.ShadowWrap.Draw.resetMoveMarkers(a),L.ShadowWrap.Draw.resetCircleResizer(a))}};this.on("move",e),this.on("resize",e),this.on("edit",e),this.on("shadowRemoved",function(a){if(a.shadowLayer.hasOwnProperty("editing")){var e=a.shadowLayer.shadowOptions.mainShape;a.shadowLayer.fire=L.ShadowWrap.Draw.makeFakeFirer(a.shadowLayer,e,e),a.shadowLayer._map=L.Util.extend(e._map),a.shadowLayer.editing._map=L.Util.extend(e._map),e._focusNextUpdate=!0}}),this.on("editstart",function(e){a.hasOwnProperty("_focusNextUpdate")&&delete a._focusNextUpdate,(e._shadowDispatched||0!==Object.keys(a.shadowOptions.shadowShapes).length)&&a.blockShadowChanges()});var r=function(e){a.hasOwnProperty("_focusNextUpdate")&&delete a._focusNextUpdate};this._map?(this._map.on(L.Draw.Event.CANCELED,r),this._map.on(L.Draw.Event.EDITDONE,r)):this.on("add",function(){a._map.on(L.Draw.Event.CANCELED,r),a._map.on(L.Draw.Event.EDITDONE,r)})}},focusUpdate:function(a){a._latlng?a._map.panTo(a._latlng):a._map.panTo(a.getBounds().getCenter()),delete a._focusNextUpdate},resetMoveMarkers:function(a){a.editing._moveMarker&&(a.editing._moveMarker.setLatLng(a.guideLL(a.getBounds().getCenter())),a.editing._moveMarker.update())},resetCircleResizer:function(a,e){if(a.editing._getResizeMarkerPoint&&(a.editing._resizeMarkers[0].setLatLng(a.guideLL(a.editing._resizeMarkers[0]._latlng)),a.editing._resizeMarkers[0].update(),e)){var r=e.editing._getResizeMarkerPoint(e.getBounds().getCenter());e.editing._resizeMarkers[0].setLatLng(e.guideLL(r)),e.editing._resizeMarkers[0].update()}},shadowUpdate:function(a,e,r){if(!r.options.noShadow)if(r instanceof L.Marker)r.hasOwnProperty("_originalLatLng")&&!e.hasOwnProperty("_originalLatLng")?(e._originalLatLng=e.guideLL(r._originalLatLng),e.setLatLng(e.guideLL(r._latlng)),e.update()):e.hasOwnProperty("_originalLatLng")&&!r.hasOwnProperty("_originalLatLng")&&(r._originalLatLng=r.guideLL(e._originalLatLng),r.setLatLng(r.guideLL(e._latlng)),r.update());else{if(L.ShadowWrap.Draw.resetMoveMarkers(r),L.ShadowWrap.Draw.resetMoveMarkers(e),!(r instanceof L.Rectangle)&&r instanceof L.Polyline)return e._setLatLngs(e._latlngs),L.ShadowWrap.Draw.fixEditMarkers(r,r.editing),L.ShadowWrap.Draw.fixEditMarkers(e,e.editing),r.editing.updateMarkers(),L.ShadowWrap.Draw.fixEditMarkers(r,r.editing),void L.ShadowWrap.Draw.fixEditMarkers(e,e.editing);r.editing._repositionCornerMarkers?r.editing._repositionCornerMarkers():L.ShadowWrap.Draw.resetCircleResizer(e,r)}},fixEditMarkers:function(a,e){if(!(a instanceof L.Marker)){var r;if(e._markerGroup)for(r in e._markerGroup._layers)e._markerGroup._layers.hasOwnProperty(r)&&L.ShadowWrap.Draw.fixDrawMarker(a,e._markerGroup._layers[r]);if(e._verticesHandlers)for(var o=0;o<e._verticesHandlers.length;o++){var t=e._verticesHandlers[o]._markerGroup;if(t)for(r in t._layers)t._layers.hasOwnProperty(r)&&L.ShadowWrap.Draw.fixDrawMarker(a,t._layers[r])}}},fixDrawMarker:function(a,e){a.options.noShadow||(e._latlng=a.guideLL(e._latlng),e.update()),e.unshadow()},processDrawnItem:function(a,e,r,o){if(e.addLayer(o),r&&r.push(o),o.hasOwnProperty("shadowOptions"))for(var t in o.shadowOptions.shadowShapes)if(o.shadowOptions.shadowShapes.hasOwnProperty(t)){var n=o.shadowOptions.shadowShapes[t];e.addLayer(n),r&&r.push(n)}o.on("shadowAdded",function(a){e.addLayer(a.shadowLayer),r&&r.push(a.shadowLayer)}),o.on("shadowRemoved",function(o){if(e.removeLayer(o.shadowLayer),r)for(var t=L.stamp(o.shadowLayer),n=0;n<r.length;n++)if(L.stamp(r[n])==t){r.splice(n,1);break}var i=o.shadowLayer.shadowOptions.mainShape;a.undoManager.editHandlerIndex.hasOwnProperty(o.shadowLayer._leaflet_id)&&(a.undoManager.editHandlerIndex.hasOwnProperty(i._leaflet_id)?a.undoManager.editHandlerIndex[o.shadowLayer._leaflet_id]=a.undoManager.editHandlerIndex[i._leaflet_id]:(a.undoManager.editHandlerIndex[o.shadowLayer._leaflet_id]=i._editing,a.undoManager.editHandlerIndex[i._leaflet_id]=i._editing)),a.undoManager.editHandlerIndex.hasOwnProperty("v"+o.shadowLayer._leaflet_id)&&(a.undoManager.editHandlerIndex.hasOwnProperty("v"+i._leaflet_id)?a.undoManager.editHandlerIndex["v"+o.shadowLayer._leaflet_id]=a.undoManager.editHandlerIndex[i._leaflet_id]:(a.undoManager.editHandlerIndex["v"+o.shadowLayer._leaflet_id]=i._editing._verticesHandlers[0],a.undoManager.editHandlerIndex["v"+i._leaflet_id]=i._editing._verticesHandlers[0]));for(var d=["undoStack","redoStack"],s=0;s<d.length;s++)for(var l=d[s],h=0;h<a.undoManager.stateHandler[l].length;h++){var p=a.undoManager.stateHandler[l][h];p.params.layer._leaflet_id==o.shadowLayer._leaflet_id&&(p.params.layer=i)}})},hookCallbacks:function(a,e,r){e._map.on(L.Draw.Event.CREATED,function(o){o.layer.options.noShadow&&o.layer.addShadows(),L.ShadowWrap.Draw.processDrawnItem(a,e,r,o.layer)}),e._map.on(L.Draw.Event.EDITHOOK,function(a){L.ShadowWrap.Draw.fixEditMarkers(a.layer,a.editHandler)}),e._map.on(L.Draw.Event.DRAWVERTEX,function(a){var e=a.drawHandler._poly;e.options.noShadow||e.unshadow();var r=a.drawHandler._markers.length-1,o=a.drawHandler._markers[r];o._latlng=e._latlngs[r],o.unshadow(),o.update()}),e._map.on(L.Draw.Event.DRAWSTART,function(a){var e=L.toolbar._toolbars.draw._modes[a.layerType].handler;e._mouseMarker&&e._mouseMarker.unshadow()})},hookLeafletDraw:function(a,e,r,o){null!==o&&void 0!==o||(o=[]);for(var t=0;t<o.length;t++)L.ShadowWrap.Draw.processDrawnItem(a,e,r,o[t]);e._map?L.ShadowWrap.Draw.hookCallbacks(a,e,r):e.on("add",function(){L.ShadowWrap.Draw.hookCallbacks(a,e,r)})}},L.ShadowWrap.hookLeafletDraw=L.ShadowWrap.Draw.hookLeafletDraw,L.ShadowWrap.Draw.makeFakeFirer=function(a,e,r){return function(o,t,n){if(o.startsWith("draw:")){if(o==L.Draw.Event.EDITVERTEX){var i=t.marker._index;t.marker=r.editing._verticesHandlers[0]._markers[i]}if(t.hasOwnProperty("layer")&&t.layer._leaflet_id==a._leaflet_id&&(t.layer=r,t.hasOwnProperty("editHandler")&&(t.vertex?t.editHandler=r.editing._verticesHandlers[0]:t.editHandler=r.editing)),t.hasOwnProperty("poly")&&t.poly._leaflet_id==a._leaflet_id&&(t.poly=r),t.hasOwnProperty("layers"))for(var d=0;d<t.layers.length;d++){var s=t.layers[d];s.hasOwnProperty("_leaflet_id")&&s._leaflet_id==a._leaflet_id&&(t.layers[d]=r)}}return L.Evented.prototype.fire.call(e,o,t,n)}},L.EditToolbar.Edit.prototype.__original_disableLayerEdit=L.EditToolbar.Edit.prototype._disableLayerEdit,L.EditToolbar.Edit.prototype._disableLayerEdit=function(a){var e=a.layer||a.target||a;if(e._map)try{e.hasOwnProperty("dragging")?this.__original_disableLayerEdit(a):(e.dragging={disable:function(){}},this.__original_disableLayerEdit(a),delete e.dragging)}catch(a){}},L.ShadowWrap.addExtension("Leaflet.ShadowWrap.Draw",function(){L.Marker.addInitHook(L.ShadowWrap.Draw.initializeShadowHooks),L.CircleMarker.addInitHook(L.ShadowWrap.Draw.initializeShadowHooks),L.Polyline.addInitHook(L.ShadowWrap.Draw.initializeShadowHooks);var a=L.EditToolbar.Edit.prototype._revertLayers;L.EditToolbar.Edit.prototype._revertLayers=function(e,r){e.hasOwnProperty("shadowOptions")&&e.shadowOptions.isShadow||a.call(this,e,r)},L.ShadowWrap.addShadowException("L.Path","setStyle",L.Edit.SimpleShape.prototype.removeHooks),L.ShadowWrap.addShadowException("L.Path","setStyle",L.Edit.PolyVerticesEdit.prototype.removeHooks)}),L.Edit.PolyVerticesEdit.prototype._getMiddleLatLng=function(a,e){var r=this._poly._map,o=r.project(this._poly._latlngs[0][a._index]),t=r.project(this._poly._latlngs[0][e._index]);return r.unproject(o._add(t)._divideBy(2))};